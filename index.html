<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìŠ¤ë§ˆíŠ¸ ë°˜ë°°ì¹˜ ì‹œìŠ¤í…œ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Malgun Gothic', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      text-align: center;
    }

    h1 {
      color: #333;
      font-size: 32px;
      margin-bottom: 10px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* ì„¤ì • í˜ì´ì§€ */
    .settings-page {
      max-width: 700px;
      margin: 0 auto;
    }

    .settings-box {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .form-group {
      margin-bottom: 25px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
      font-size: 15px;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #333;
    }

    button {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #333;
      color: white;
    }

    .btn-primary:hover {
      background: #555;
    }

    /* ì—…ë¡œë“œ í˜ì´ì§€ */
    .upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .upload-box {
      border: 3px dashed #ccc;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      position: relative;
    }

    .upload-box:hover {
      border-color: #333;
      background: #f9f9f9;
    }

    .upload-box.uploaded {
      border-color: #4CAF50;
      background: #e8f5e9;
    }

    .upload-box.dragover {
      border-color: #333;
      background: #e8e8e8;
      transform: scale(1.02);
    }

    /* ê²°ê³¼ í˜ì´ì§€ */
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .class-column {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      min-height: 400px;
    }

    .class-header {
      background: #333;
      color: white;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .student-card {
      background: white;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      cursor: move;
      border: 2px solid transparent;
      transition: all 0.2s;
      text-align: center;
    }

    .student-card:hover {
      border-color: #333;
      transform: scale(1.02);
    }

    .student-card.female {
      background: #FFE4E1;
    }

    .student-card.male {
      background: #E0F2FF;
    }

    .student-card.dragging {
      opacity: 0.5;
    }

    .delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .student-card:hover .delete-btn {
      display: flex;
    }

    .action-bar {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .action-bar button {
      flex: 1;
    }

    .btn-success {
      background: #4CAF50;
      color: white;
    }

    .btn-success:hover {
      background: #45a049;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #da190b;
    }

    .legend {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 10px;
    }

    .legend-item {
      padding: 8px 15px;
      background: white;
      border-radius: 5px;
      border: 1px solid #ddd;
      font-size: 14px;
    }

    .message {
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: center;
      font-weight: bold;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ« ìŠ¤ë§ˆíŠ¸ ë°˜ë°°ì¹˜ ì‹œìŠ¤í…œ</h1>
      <p style="color: #666; margin-top: 10px;">PDF ì—…ë¡œë“œë§Œìœ¼ë¡œ ìë™ ë°˜ë°°ì¹˜ ì™„ì„±</p>
    </header>

    <!-- í˜ì´ì§€ 1: ì„¤ì • -->
    <div class="page active" id="page1">
      <div class="settings-page">
        <div class="settings-box">
          <h2 style="margin-bottom: 20px;">âš™ï¸ ì´ˆê¸° ì„¤ì •</h2>
          
          <!-- ì‚¬ìš© ë°©ë²• -->
          <div style="background: #f0f8ff; border-left: 4px solid #2196F3; padding: 20px; margin-bottom: 30px; border-radius: 8px;">
            <h3 style="color: #1976D2; margin-bottom: 15px;">ğŸ“‹ ì‚¬ìš© ë°©ë²•</h3>
            <ul style="line-height: 2; color: #333; margin-left: 20px;">
              <li><strong>ë™í•™ë…„ ë¶€ì¥ ì„ ìƒë‹˜</strong>ì´ ê° ë°˜ì˜ ì„±ì ìˆœ ëª…ë ¬í‘œ PDFë¥¼ ëª¨ë‘ ë°›ìŠµë‹ˆë‹¤</li>
              <li>1ë°˜ë¶€í„° ìˆœì„œëŒ€ë¡œ PDF íŒŒì¼ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤</li>
              <li>í•™ìƒë“¤ì€ ì„±ì ìˆœìœ¼ë¡œ <strong>ì„¤ì •í•œ ë°˜ ìˆ˜ë§Œí¼</strong> ìë™ìœ¼ë¡œ ê· ë“± ë°°ì¹˜ë©ë‹ˆë‹¤</li>
              <li><strong>ë°°ì¹˜ ì›ë¦¬</strong>: 1ë°˜ ì—¬í•™ìƒ 1ë“±â†’ê°€ë°˜, ë‚¨í•™ìƒ 1ë“±â†’ë¼ë°˜ë¶€í„° ì‹œì‘ (ê· ë“± ë¶„ì‚°)</li>
              <li>ëª¨ë“  ë°˜ ì—…ë¡œë“œ ì™„ë£Œ í›„ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ë“œë˜ê·¸ë¡œ ì¡°ì •í•©ë‹ˆë‹¤</li>
              <li>ìµœì¢…ì ìœ¼ë¡œ <strong>ì—‘ì…€ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ</strong>í•˜ì—¬ ì—…ë¬´ì— í™œìš©í•©ë‹ˆë‹¤</li>
              <li>âš ï¸ ë°ì´í„°ëŠ” <strong>ì´ ì»´í“¨í„°ì˜ ë¸Œë¼ìš°ì €ì—ë§Œ</strong> ì €ì¥ë©ë‹ˆë‹¤ (ë‹¤ë¥¸ ì‚¬ëŒê³¼ ê³µìœ  ì•ˆ ë¨)</li>
            </ul>
          </div>

          <div style="background: #fff3e0; border-left: 4px solid #FF9800; padding: 15px; margin-bottom: 30px; border-radius: 8px;">
            <h3 style="color: #F57C00; margin-bottom: 10px;">ğŸ¨ í‘œì‹œ ê¸°í˜¸</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; font-size: 14px;">
              <span style="background: white; padding: 5px 10px; border-radius: 5px;">â­ ìƒí™œì§€ë„</span>
              <span style="background: white; padding: 5px 10px; border-radius: 5px;"># íŠ¹ìˆ˜</span>
              <span style="background: white; padding: 5px 10px; border-radius: 5px;">â— í•™ìŠµë¶€ì§„</span>
              <span style="background: white; padding: 5px 10px; border-radius: 5px;">@ ë‹¤ë¬¸í™”</span>
              <span style="background: #FFE4E1; padding: 5px 10px; border-radius: 5px;">ì—¬í•™ìƒ</span>
              <span style="background: #E0F2FF; padding: 5px 10px; border-radius: 5px;">ë‚¨í•™ìƒ</span>
            </div>
          </div>
          
          <div class="form-group">
            <label>í•™êµëª…</label>
            <input type="text" id="schoolName" placeholder="ì˜ˆ: ì„œìš¸ì´ˆë“±í•™êµ">
          </div>
          
          <div class="form-group">
            <label>í˜„ì¬ í•™ë…„</label>
            <input type="number" id="grade" placeholder="ì˜ˆ: 5" min="1" max="6">
          </div>
          
          <div class="form-group">
            <label>í˜„ì¬ ì´ ë°˜ ìˆ˜ (ì—…ë¡œë“œí•  ë°˜ ìˆ˜)</label>
            <select id="currentClasses">
              <option value="3">3ê°œ ë°˜</option>
              <option value="4">4ê°œ ë°˜</option>
              <option value="5">5ê°œ ë°˜</option>
              <option value="6" selected>6ê°œ ë°˜</option>
              <option value="7">7ê°œ ë°˜</option>
              <option value="8">8ê°œ ë°˜</option>
              <option value="9">9ê°œ ë°˜</option>
              <option value="10">10ê°œ ë°˜</option>
            </select>
          </div>

          <div class="form-group">
            <label>ë°°ì •í•  ì´ ë°˜ ìˆ˜ (ë‚´ë…„ë„ ë°˜ ìˆ˜)</label>
            <select id="totalClasses">
              <option value="3">3ê°œ ë°˜</option>
              <option value="4">4ê°œ ë°˜</option>
              <option value="5">5ê°œ ë°˜</option>
              <option value="6" selected>6ê°œ ë°˜</option>
              <option value="7">7ê°œ ë°˜</option>
              <option value="8">8ê°œ ë°˜</option>
              <option value="9">9ê°œ ë°˜</option>
              <option value="10">10ê°œ ë°˜</option>
            </select>
          </div>
          
          <button class="btn-primary" onclick="saveSettings()">ì„¤ì • ì €ì¥ ë° ì‹œì‘í•˜ê¸°</button>
          
          <div id="settingsMessage"></div>
        </div>
      </div>
    </div>

    <!-- í˜ì´ì§€ 2: ì—…ë¡œë“œ -->
    <div class="page" id="page2">
      <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h2 style="margin-bottom: 20px;">ğŸ“¤ ëª…ë ¬í‘œ ì—…ë¡œë“œ</h2>
        
        <div class="legend">
          <strong>ğŸ“Œ í‘œì‹œ ê¸°í˜¸</strong>
          <div class="legend-items">
            <div class="legend-item">â­ ìƒí™œì§€ë„</div>
            <div class="legend-item"># íŠ¹ìˆ˜</div>
            <div class="legend-item">â— í•™ìŠµë¶€ì§„</div>
            <div class="legend-item">@ ë‹¤ë¬¸í™”</div>
            <div class="legend-item" style="background: #FFE4E1;">ì—¬í•™ìƒ</div>
            <div class="legend-item" style="background: #E0F2FF;">ë‚¨í•™ìƒ</div>
          </div>
        </div>

        <div class="upload-grid" id="uploadGrid"></div>

        <div class="action-bar">
          <button class="btn-success" onclick="showPage(3)">ë°°ì¹˜ ê²°ê³¼ í™•ì¸í•˜ê¸° â†’</button>
        </div>

        <div id="uploadMessage"></div>
      </div>
    </div>

    <!-- í˜ì´ì§€ 3: ê²°ê³¼ -->
    <div class="page" id="page3">
      <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h2 style="margin-bottom: 10px;">ğŸ“Š ë°˜ë°°ì¹˜ ê²°ê³¼</h2>
        <p style="color: #666; margin-bottom: 20px;">ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ í•™ìƒì„ ë‹¤ë¥¸ ë°˜ìœ¼ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>

        <div class="legend">
          <strong>ğŸ“Œ í‘œì‹œ ê¸°í˜¸</strong>
          <div class="legend-items">
            <div class="legend-item">â­ ìƒí™œì§€ë„</div>
            <div class="legend-item"># íŠ¹ìˆ˜</div>
            <div class="legend-item">â— í•™ìŠµë¶€ì§„</div>
            <div class="legend-item">@ ë‹¤ë¬¸í™”</div>
          </div>
        </div>

        <div class="result-grid" id="resultGrid"></div>

        <div class="action-bar">
          <button class="btn-primary" onclick="showPage(2)">â† ì—…ë¡œë“œ í˜ì´ì§€ë¡œ</button>
          <button class="btn-success" onclick="downloadExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
          <button class="btn-danger" onclick="resetAll()">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</button>
        </div>

        <div id="resultMessage"></div>
      </div>
    </div>
  </div>

  <script>
    // PDF.js Worker ì„¤ì • (Warning ì œê±°)
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    }

    let settings = {
      schoolName: '',
      grade: '',
      currentClasses: 6,
      totalClasses: 6
    };

    let distributedStudents = {};
    let uploadedClasses = {}; // ì—…ë¡œë“œëœ ë°˜ ì¶”ì 
    let draggedStudent = null;
    let draggedFrom = null;

    const classNames = ['ê°€ë°˜', 'ë‚˜ë°˜', 'ë‹¤ë°˜', 'ë¼ë°˜', 'ë§ˆë°˜', 'ë°”ë°˜', 'ì‚¬ë°˜', 'ì•„ë°˜', 'ìë°˜', 'ì°¨ë°˜'];

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì €ì¥ëœ ë°ì´í„° ë³µì›
    window.addEventListener('load', function() {
      loadAutoSave();
    });

    // ìë™ ì €ì¥
    function autoSave() {
      const data = {
        settings: settings,
        distributedStudents: distributedStudents,
        uploadedClasses: uploadedClasses,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem('classDistribution_autoSave', JSON.stringify(data));
    }

    // ìë™ ì €ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    function loadAutoSave() {
      const saved = localStorage.getItem('classDistribution_autoSave');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (confirm('ìë™ ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ì´ì–´ì„œ ì‘ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            settings = data.settings;
            distributedStudents = data.distributedStudents;
            uploadedClasses = data.uploadedClasses || {};
            
            // ì„¤ì • ê°’ ë³µì›
            document.getElementById('schoolName').value = settings.schoolName;
            document.getElementById('grade').value = settings.grade;
            document.getElementById('currentClasses').value = settings.currentClasses;
            document.getElementById('totalClasses').value = settings.totalClasses;
            
            if (settings.schoolName && settings.grade) {
              showPage(2);
            }
          }
        } catch (error) {
          console.error('ìë™ ì €ì¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      }
    }

    // ìë™ ì €ì¥ ì‚­ì œ
    function clearAutoSave() {
      localStorage.removeItem('classDistribution_autoSave');
    }

    function showPage(pageNum) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page' + pageNum).classList.add('active');

      if (pageNum === 2) {
        initUploadGrid();
      } else if (pageNum === 3) {
        renderResult();
      }
    }

    function saveSettings() {
      settings.schoolName = document.getElementById('schoolName').value;
      settings.grade = document.getElementById('grade').value;
      settings.currentClasses = parseInt(document.getElementById('currentClasses').value);
      settings.totalClasses = parseInt(document.getElementById('totalClasses').value);

      if (!settings.schoolName || !settings.grade) {
        showMessage('settingsMessage', 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      // ë°˜ ì´ˆê¸°í™”
      distributedStudents = {};
      uploadedClasses = {};
      for (let i = 0; i < settings.totalClasses; i++) {
        distributedStudents[classNames[i] + '(ì—¬)'] = [];
        distributedStudents[classNames[i] + '(ë‚¨)'] = [];
      }

      autoSave(); // ìë™ ì €ì¥
      showMessage('settingsMessage', 'ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
      setTimeout(() => showPage(2), 1000);
    }

    function initUploadGrid() {
      const grid = document.getElementById('uploadGrid');
      grid.innerHTML = '';

      for (let i = 1; i <= settings.currentClasses; i++) {
        const box = document.createElement('div');
        box.className = 'upload-box';
        if (uploadedClasses[i]) {
          box.classList.add('uploaded');
        }
        box.id = 'upload-box-' + i;
        
        if (uploadedClasses[i]) {
          box.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 10px;">âœ…</div>
            <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">${i}ë°˜ ì™„ë£Œ</div>
            <div style="color: #2e7d32; font-size: 14px; margin-bottom: 10px;">ì—¬: ${uploadedClasses[i].female}ëª… / ë‚¨: ${uploadedClasses[i].male}ëª…</div>
            <button onclick="reuploadClass(${i}); event.stopPropagation();" style="background: #FF9800; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">ë‹¤ì‹œ ì—…ë¡œë“œ</button>
          `;
        } else {
          box.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“„</div>
            <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">${i}ë°˜</div>
            <div style="color: #666; font-size: 14px;">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
            <input type="file" accept=".pdf,.txt" style="display: none;" id="file-input-${i}">
          `;
        }
        
        const input = box.querySelector('input');
        if (input) {
          // í´ë¦­ ì—…ë¡œë“œ
          box.onclick = function(e) {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
              input.click();
            }
          };
          
          input.onchange = function(e) {
            handleFileUpload(e, i);
          };
          
          // ë“œë˜ê·¸ ì•¤ ë“œë¡­
          box.ondragover = function(e) {
            e.preventDefault();
            e.stopPropagation();
            box.classList.add('dragover');
          };
          
          box.ondragleave = function(e) {
            e.preventDefault();
            e.stopPropagation();
            box.classList.remove('dragover');
          };
          
          box.ondrop = function(e) {
            e.preventDefault();
            e.stopPropagation();
            box.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              const fakeEvent = { target: { files: [files[0]] } };
              handleFileUpload(fakeEvent, i);
            }
          };
        }
        
        grid.appendChild(box);
      }
    }

    // ë°˜ ì¬ì—…ë¡œë“œ
    function reuploadClass(classNumber) {
      // í•´ë‹¹ ë°˜ í•™ìƒë“¤ ì œê±°
      for (let key in distributedStudents) {
        distributedStudents[key] = distributedStudents[key].filter(s => s.originalClass !== classNumber);
      }
      
      // ì—…ë¡œë“œ ê¸°ë¡ ì‚­ì œ
      delete uploadedClasses[classNumber];
      
      autoSave();
      initUploadGrid();
      showMessage('uploadMessage', `${classNumber}ë°˜ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.`, 'success');
    }

    async function handleFileUpload(event, classNumber) {
      const file = event.target.files[0];
      if (!file) return;

      const box = document.getElementById('upload-box-' + classNumber);
      box.innerHTML = '<div style="padding: 20px;">â³ ì²˜ë¦¬ ì¤‘...</div>';

      try {
        let text = '';
        
        if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
          try {
            text = await extractPDFText(file);
          } catch (pdfError) {
            console.log('PDF íŒŒì‹± ì‹¤íŒ¨, í…ìŠ¤íŠ¸ë¡œ ì‹œë„:', pdfError);
            text = await file.text();
          }
        } else {
          text = await file.text();
        }

        const students = parseStudentData(text);
        distributeStudents(students, classNumber);

        // ì—…ë¡œë“œ ê¸°ë¡ ì €ì¥
        uploadedClasses[classNumber] = {
          female: students.female.length,
          male: students.male.length
        };

        box.classList.add('uploaded');
        box.innerHTML = `
          <div style="font-size: 48px; margin-bottom: 10px;">âœ…</div>
          <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">${classNumber}ë°˜ ì™„ë£Œ</div>
          <div style="color: #2e7d32; font-size: 14px; margin-bottom: 10px;">ì—¬: ${students.female.length}ëª… / ë‚¨: ${students.male.length}ëª…</div>
          <button onclick="reuploadClass(${classNumber}); event.stopPropagation();" style="background: #FF9800; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">ë‹¤ì‹œ ì—…ë¡œë“œ</button>
        `;
        
        autoSave(); // ìë™ ì €ì¥
        showMessage('uploadMessage', `${classNumber}ë°˜ í•™ìƒ ë°°ì¹˜ ì™„ë£Œ!`, 'success');
      } catch (error) {
        box.classList.remove('uploaded');
        initUploadGrid();
        showMessage('uploadMessage', `íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
        console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
      }
    }

    async function extractPDFText(file) {
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ 
          data: arrayBuffer,
          verbosity: 0  // ë¡œê·¸ ìµœì†Œí™”
        }).promise;
        let fullText = '';

        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + '\n';
        }

        return fullText;
      } catch (error) {
        console.error('PDF íŒŒì‹± ì˜¤ë¥˜:', error);
        throw new Error('PDF íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ë³€í™˜ í›„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
      }
    }

    function parseStudentData(text) {
      const lines = text.split('\n');
      const female = [];
      const male = [];

      for (let line of lines) {
        const parts = line.trim().split(/\s+/);

        for (let i = 0; i < parts.length; i++) {
          if (parts[i] === 'ì—¬' && parts[i + 1]) {
            const name = parts[i + 1];
            let note = '';

            for (let j = i + 2; j < i + 5 && j < parts.length; j++) {
              if (parts[j] === 'ë‚¨' || parts[j] === 'ì—¬') break;
              if (parts[j] && !parts[j].match(/^\d+$/)) {
                note = parts[j];
                break;
              }
            }

            female.push({ name, note, gender: 'ì—¬' });
          } else if (parts[i] === 'ë‚¨' && parts[i + 1]) {
            const name = parts[i + 1];
            let note = '';

            for (let j = i + 2; j < i + 5 && j < parts.length; j++) {
              if (parts[j] === 'ë‚¨' || parts[j] === 'ì—¬') break;
              if (parts[j] && !parts[j].match(/^\d+$/)) {
                note = parts[j];
                break;
              }
            }

            male.push({ name, note, gender: 'ë‚¨' });
          }
        }
      }

      return { female, male };
    }

    function distributeStudents(students, classNumber) {
      const totalClasses = settings.totalClasses;
      const femaleStart = (classNumber - 1) % totalClasses;
      const maleStart = (classNumber - 1 + Math.floor(totalClasses / 2)) % totalClasses;

      students.female.forEach((student, i) => {
        const classIndex = (femaleStart + i) % totalClasses;
        const className = classNames[classIndex] + '(ì—¬)';
        const prefix = getPrefix(student.note);
        
        distributedStudents[className].push({
          ...student,
          displayName: prefix + student.name,
          originalClass: classNumber
        });
      });

      students.male.forEach((student, i) => {
        const classIndex = (maleStart + i) % totalClasses;
        const className = classNames[classIndex] + '(ë‚¨)';
        const prefix = getPrefix(student.note);
        
        distributedStudents[className].push({
          ...student,
          displayName: prefix + student.name,
          originalClass: classNumber
        });
      });
    }

    function getPrefix(note) {
      if (!note) return '';
      const lower = note.toLowerCase();
      if (lower.includes('ìƒí™œì§€ë„')) return 'â­';
      if (lower.includes('íŠ¹ìˆ˜')) return '#';
      if (lower.includes('í•™ìŠµë¶€ì§„')) return 'â—';
      if (lower.includes('ë‹¤ë¬¸í™”')) return '@';
      return '';
    }

    function renderResult() {
      const grid = document.getElementById('resultGrid');
      grid.innerHTML = '';

      for (let i = 0; i < settings.totalClasses; i++) {
        // ì—¬í•™ìƒ ì—´
        const femaleCol = createClassColumn(classNames[i] + '(ì—¬)', 'female');
        grid.appendChild(femaleCol);

        // ë‚¨í•™ìƒ ì—´
        const maleCol = createClassColumn(classNames[i] + '(ë‚¨)', 'male');
        grid.appendChild(maleCol);
      }
    }

    function createClassColumn(className, gender) {
      const col = document.createElement('div');
      col.className = 'class-column';
      col.style.background = gender === 'female' ? '#FFF0F0' : '#F0F8FF';

      const header = document.createElement('div');
      header.className = 'class-header';
      header.textContent = className;
      col.appendChild(header);

      col.ondragover = (e) => e.preventDefault();
      col.ondrop = (e) => {
        e.preventDefault();
        if (draggedStudent && draggedFrom !== className) {
          distributedStudents[draggedFrom] = distributedStudents[draggedFrom].filter(s => s.name !== draggedStudent.name);
          distributedStudents[className].push(draggedStudent);
          autoSave(); // ìë™ ì €ì¥
          renderResult();
        }
      };

      const students = distributedStudents[className] || [];
      students.forEach(student => {
        const card = document.createElement('div');
        card.className = 'student-card ' + gender;
        card.draggable = true;
        card.style.position = 'relative';
        card.innerHTML = `
          <button class="delete-btn" onclick="deleteStudent('${className}', '${student.name}'); event.stopPropagation();" title="í•™ìƒ ì‚­ì œ">Ã—</button>
          <div style="font-weight: bold; font-size: 14px;">${student.displayName}</div>
          ${student.note ? `<div style="font-size: 11px; color: #666; margin-top: 5px;">${student.note}</div>` : ''}
        `;

        card.ondragstart = () => {
          draggedStudent = student;
          draggedFrom = className;
          card.classList.add('dragging');
        };

        card.ondragend = () => {
          card.classList.remove('dragging');
        };

        col.appendChild(card);
      });

      return col;
    }

    // í•™ìƒ ì‚­ì œ
    function deleteStudent(className, studentName) {
      if (confirm(`${studentName.replace(/^[â­#â—@]/, '')} í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        distributedStudents[className] = distributedStudents[className].filter(s => s.name !== studentName);
        autoSave(); // ìë™ ì €ì¥
        renderResult();
        showMessage('resultMessage', 'í•™ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      }
    }

    function downloadExcel() {
      try {
        const workbook = XLSX.utils.book_new();

        // ê° ë°˜ë³„ë¡œ ì‹œíŠ¸ ìƒì„±
        for (let i = 0; i < settings.totalClasses; i++) {
          const className = classNames[i];
          const femaleStudents = distributedStudents[className + '(ì—¬)'] || [];
          const maleStudents = distributedStudents[className + '(ë‚¨)'] || [];

          // ì‹œíŠ¸ ë°ì´í„° ìƒì„±
          const sheetData = [
            ['ì´ë¦„', 'ì„±ë³„', 'ë¹„ê³ ']
          ];

          // ì—¬í•™ìƒ ì¶”ê°€
          femaleStudents.forEach(s => {
            const cleanName = s.name.replace(/^[â­#â—@]/, '');
            sheetData.push([cleanName, 'ì—¬', s.note || '']);
          });

          // ë‚¨í•™ìƒ ì¶”ê°€
          maleStudents.forEach(s => {
            const cleanName = s.name.replace(/^[â­#â—@]/, '');
            sheetData.push([cleanName, 'ë‚¨', s.note || '']);
          });

          // ì‹œíŠ¸ ìƒì„± ë° ì¶”ê°€
          const worksheet = XLSX.utils.aoa_to_sheet(sheetData);
          
          // ì—´ ë„ˆë¹„ ì„¤ì •
          worksheet['!cols'] = [
            { wch: 12 },  // ì´ë¦„
            { wch: 6 },   // ì„±ë³„
            { wch: 15 }   // ë¹„ê³ 
          ];

          XLSX.utils.book_append_sheet(workbook, worksheet, className);
        }

        // ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        const fileName = `${settings.schoolName}_${settings.grade}í•™ë…„_ë°˜ë°°ì¹˜ê²°ê³¼.xlsx`;
        XLSX.writeFile(workbook, fileName);

        showMessage('resultMessage', 'ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
      } catch (error) {
        console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
        showMessage('resultMessage', 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
      }
    }

    function resetAll() {
      if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        distributedStudents = {};
        uploadedClasses = {};
        clearAutoSave(); // ìë™ ì €ì¥ ì‚­ì œ
        showPage(1);
        document.getElementById('schoolName').value = '';
        document.getElementById('grade').value = '';
      }
    }

    function showMessage(elementId, message, type) {
      const msgDiv = document.getElementById(elementId);
      msgDiv.textContent = message;
      msgDiv.className = 'message ' + type;
      msgDiv.style.display = 'block';

      setTimeout(() => {
        msgDiv.style.display = 'none';
      }, 5000);
    }
  </script>
</body>
</html>